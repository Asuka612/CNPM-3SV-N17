{% extends 'layout/base.html' %}
{% block content %}
<script src="{{ url_for('static', filename='js/medicine.js') }}"></script>

<h2>K√™ Toa Thu·ªëc (Phi·∫øu ƒëi·ªÅu tr·ªã #{{ toa_thuoc.PhieuDieuTriId }})</h2>

<form class="bg-white p-3 rounded shadow-sm" method="POST" action="/medicine/add">

    <input type="hidden" name="toa_thuoc_id" value="{{ toa_thuoc.id }}">

    <div class="form-group">
        <label>Ch·ªçn thu·ªëc (Ch·ªâ hi·ªán thu·ªëc c√≥ l√¥ HSD > 10 ng√†y)</label>
        <select name="thuoc_id" class="form-control" id="thuocSelect" required>
            <option value="">-- Ch·ªçn thu·ªëc --</option>
            {% for item in medicines %}
            <option value="{{ item[0].id }}" data-stock="{{ item.total_stock }}" data-unit="{{ item[0].DonVi }}">
                {{ item[0].TenThuoc }} - (T·ªìn: {{ item.total_stock }})
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="row">
        <div class="col-md-6">
            <input type="number" step="0.1" name="lieu_dung" id="lieuDung" class="form-control" placeholder="Li·ªÅu d√πng"
                   required onchange="checkStock()">
        </div>
        <div class="col-md-6">
            <input type="number" name="so_ngay" id="soNgay" class="form-control" placeholder="S·ªë ng√†y" required
                   onchange="checkStock()">
        </div>
    </div>
    <div class="mt-2">
        <small class="text-muted">T·ªïng d·ª± ki·∫øn: <span id="totalPreview">0</span> vi√™n</small>
        <small id="stockWarning" class="text-danger" style="display:none; font-weight:bold;">Qu√° t·ªìn kho!</small>
    </div>
    <div class="form-group mt-3">
        <input type="text" name="ghi_chu" class="form-control" placeholder="Ghi ch√∫...">
    </div>

    <button type="submit" class="btn btn-primary mt-3" id="btnSubmit">Th√™m v√†o b·∫£ng k√™</button>
</form>

<hr>

<h3>Danh s√°ch thu·ªëc trong toa n√†y</h3>
<table class="table table-bordered table-striped mt-3 bg-white p-3 rounded shadow-sm">
    <thead>
    <tr>
        <th>#</th>
        <th>T√™n thu·ªëc</th>
        <th>Li·ªÅu d√πng</th>
        <th>S·ªë ng√†y</th>
        <th>T·ªïng SL</th>
        <th>Ghi ch√∫</th>
        <th>Thao t√°c</th>
    </tr>
    </thead>

    <tbody>
    {% for detail in toa_thuoc.ds_chi_tiet_thuoc %}
    <tr>
        <td>{{ loop.index }}</td>
        <td>{{ detail.loai_thuoc.TenThuoc }}</td>
        <td>{{ detail.LieuDung }}</td>
        <td>{{ detail.SoNgay }}</td>
        <td>{{ detail.SoLuong }} {{ detail.loai_thuoc.DonVi }}</td>

        <td>{{ detail.GhiChu }}</td>

        <td>
            <form action="/medicine/delete/{{ detail.ThuocId }}" method="POST">
                <input type="hidden" name="toa_thuoc_id" value="{{ toa_thuoc.id }}">
                <button type="submit" class="btn btn-danger btn-sm">X√≥a</button>
            </form>
        </td>
    </tr>
    {% else %}
    <tr>
        <td colspan="7" class="text-center">Ch∆∞a k√™ thu·ªëc n√†o</td>
    </tr>
    {% endfor %}
    </tbody>
</table>

<form action="/medicine/save" method="POST">
    <input type="hidden" name="toa_thuoc_id" value="{{ toa_thuoc.id }}">
    <button class="mb-3 btn btn-success" type="submit">üíæ L∆∞u & Xu·∫•t Kho</button>
</form>

{% endblock %}